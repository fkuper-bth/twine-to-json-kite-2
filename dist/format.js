window.storyFormat({
  "name": "Twine w/ Kite2 to JSON",
  "version": "0.0.8",
  "author": "Frederik Kuper",
  "description": "Convert Twine stories to JSON for the KITE 2 format.",
  "proofing": false,
  "source": "<html>\n  <head>\n    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8' />\n    <title>{{STORY_NAME}}</title>\n    <script type=\"text/javascript\">\n      let STORY_TAG_NAME=\"tw-storydata\",PASSAGE_TAG_NAME=\"tw-passagedata\",FORMAT_TWINE=\"twine\",FORMAT_HARLOWE_3=\"harlowe-3\",VALID_FORMATS=[FORMAT_TWINE,FORMAT_HARLOWE_3],KITE2_KEYWORD_TYPES=Object.freeze({SEPARATOR:\"--\",INFO_TEXT:\"info\",PLAYER_TEXT:\"player\",END:\"end\",SOUND:\"sound\",BIAS:\"bias\",CHARACTER_ACTION:\"character\"});function twineToJSON(e){var t=document.getElementsByTagName(STORY_TAG_NAME)[0],r=getElementAttributes(t),r={uuid:r.ifid,name:r.name,creator:r.creator,creatorVersion:r[\"creator-version\"],schemaName:r.format,schemaVersion:r[\"format-version\"],createdAtMs:Date.now(),startNode:r.startnode},t=(validate(e),Array.from(t.getElementsByTagName(PASSAGE_TAG_NAME)));return r.passages=t.map(t=>processPassageElement(t,e)),r}function validate(e){if(!VALID_FORMATS.some(t=>t===e))throw new Error(\"Format is not valid.\")}function processPassageElement(t,e){var r=getElementAttributes(t),r={name:r.name,tags:r.tags,id:r.pid};return r.text=t.textContent.trim(),Object.assign(r,processPassageText(r.text,e)),r.cleanText=sanitizeText(r.text,r.novelEvents,r.hooks,e),r}function processPassageText(t,e){var r={novelEvents:[]};e===FORMAT_HARLOWE_3&&(r.hooks=[]);let n=0;for(;n<t.length;){var a=extractCustomKeywordsAtIndex(t,n);if(a){if(n+=a.original.length,a.type===getPropertyName(KITE2_KEYWORD_TYPES,t=>t.CHARACTER_ACTION)||a.type===getPropertyName(KITE2_KEYWORD_TYPES,t=>t.PLAYER_TEXT)||a.type===getPropertyName(KITE2_KEYWORD_TYPES,t=>t.INFO_TEXT)){var o=extractCustomKeywordAssociatedText(n,t);if(!o)throw new Error(\"Keyword has no associated text: \"+a.typeValue);a.text=o}r.novelEvents.push(a)}o=extractLinksAtIndex(t,n);o&&(r.novelEvents.push(o),n+=o.original.length),e!==FORMAT_HARLOWE_3?n+=1:((a=extractLeftHooksAtIndex(t,n))&&(r.hooks.push(a),n+=a.original.length),(a=extractHooksAtIndex(t,n+=1))&&(r.hooks.push(a),n+=a.original.length))}return r}function extractCustomKeywordsAtIndex(t,e){if(\">\"===t[e]&&\">\"===t[e+1]){var r=getSubstringBetweenBrackets(t,e+1,\">\",\"<\"),t=t.substring(e,e+r.length+4),e=r.split(\"|\");if(2<e.length)throw new Error(\"Custom keyword has too many parts\");if(0===e.length)throw new Error(\"Custom keyword is empty\");var r=e[0].trim().toLowerCase(),n=parseCustomKeywordType(r);if(2===e.length)return{type:n,typeValue:r,associatedValue:e[1].trim(),original:t};if(1===e.length){if(n===getPropertyName(KITE2_KEYWORD_TYPES,t=>t.CHARACTER_ACTION)||n===getPropertyName(KITE2_KEYWORD_TYPES,t=>t.SOUND)||n===getPropertyName(KITE2_KEYWORD_TYPES,t=>t.BIAS))throw new Error(\"Custom keyword of type \"+n+\" requires an associated value\");return{type:n,typeValue:r,original:t}}}}function parseCustomKeywordType(t){var e,r=\"CUSTOM\";if((t=t.trim().toLowerCase()).startsWith(KITE2_KEYWORD_TYPES.CHARACTER_ACTION))return getPropertyName(KITE2_KEYWORD_TYPES,t=>t.CHARACTER_ACTION);for(e in KITE2_KEYWORD_TYPES)KITE2_KEYWORD_TYPES[e]===t&&(r=e);return r}function extractCustomKeywordAssociatedText(t,e){let r=t;for(;r<e.length;){var n=extractCustomKeywordsAtIndex(e,r),a=extractLinksAtIndex(e,r),o=extractLeftHooksAtIndex(e,r),s=extractHooksAtIndex(e,r);if(n||a||o||s)return e.substring(t,r).trim();r+=1}}function extractLinksAtIndex(t,e){var r,n,a,o,s={type:\"LINK\"};if(\"[\"===t[e]&&\"[\"===t[e+1])return n=(r=getSubstringBetweenBrackets(t,e+1)).split(\"<-\",2),a=r.split(\"->\",2),o=r.split(\"|\",2),t=t.substring(e,e+r.length+4),2===n.length?(s.linkText=n[1].trim(),s.passageName=n[0].trim()):2===a.length?(s.linkText=a[0].trim(),s.passageName=a[1].trim()):2===o.length?(s.linkText=o[0].trim(),s.passageName=o[1].trim()):(s.linkText=null,s.passageName=r.trim()),s.original=t,s}function extractLeftHooksAtIndex(t,e){if(\"|\"===t[e]){var r=getSubstringBetweenBrackets(t,e,\"|\",\">\");if(r.match(/[a-z0-9]+/i)){var n,a=e+r.length+2;if(\"[\"===t[a])return n=a+(a=getSubstringBetweenBrackets(t,a)).length+2,{hookName:r,hookText:a,original:t.substring(e,n)}}}}function extractHooksAtIndex(t,e){var r=t[e],n=e&&t[e-1];if(\"[\"===r&&\"[\"!==t[e+1]&&\"[\"!==n){r=getSubstringBetweenBrackets(t,e),n=e+r.length+2;if(\"<\"===t[n]){var a=getSubstringBetweenBrackets(t,n,\"<\",\"|\");if(a.match(/[a-z0-9]+/i))return{hookName:a,hookText:r,original:t.substring(e,n+a.length+2)}}return{hookName:void 0,hookText:r,original:t.substring(e,r.length+2)}}}function sanitizeText(e,t,r,n){return t.forEach(t=>{e=e.replace(t.original,\"\")}),n===FORMAT_HARLOWE_3&&r.forEach(t=>{e=e.replace(t.original,\"\")}),e.trim()}function getElementAttributes(t){let e={};return Array.from(t.attributes).forEach(t=>{e[t.name]=t.value}),e}function stringStartsWith(t,e){return t.trim().substring(0,e.length)===e}function getSubstringBetweenBrackets(t,e,r,n){r=r||\"[\",n=n||\"]\";var a=[];let o=e||0,s=\"\";if(t[o]!==r)throw new Error(\"startIndex of getSubstringBetweenBrackets must correspond to an open bracket, input: \",t);for(;o<t.length;){var i=t[o];if(i===n&&a.pop(),a.length&&(s+=i),i===r&&a.push(i),!a.length)return s;o+=1}return s}function getPropertyName(t,e){var r={};return Object.keys(t).map(t=>{r[t]=t}),e(r)}window.twineToJSON=twineToJSON;\n    </script>\n  </head>\n  <body>\n    <pre id=\"output\"></pre>\n    <div id=\"storyData\" style=\"display: none;\">\n      {{STORY_DATA}}\n    </div>\n    <script type='text/javascript'>document.getElementById('output').innerHTML = JSON.stringify(twineToJSON(\"harlowe-3\"), null, 2);</script>\n  </body>\n</html>"
});