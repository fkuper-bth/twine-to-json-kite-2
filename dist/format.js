window.storyFormat({
  "name": "twine-to-json-kite-2",
  "version": "0.0.4",
  "author": "Frederik Kuper",
  "description": "Convert Twine stories to JSON for the KITE 2 format.",
  "proofing": false,
  "source": "<html>\n  <head>\n    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8' />\n    <title>{{STORY_NAME}}</title>\n    <script type=\"text/javascript\">\n      let STORY_TAG_NAME=\"tw-storydata\",PASSAGE_TAG_NAME=\"tw-passagedata\",FORMAT_TWINE=\"twine\",FORMAT_HARLOWE_3=\"harlowe-3\",VALID_FORMATS=[FORMAT_TWINE,FORMAT_HARLOWE_3];function twineToJSON(e){var t=document.getElementsByTagName(STORY_TAG_NAME)[0],n=getElementAttributes(t),n={uuid:n.ifid,name:n.name,creator:n.creator,creatorVersion:n[\"creator-version\"],schemaName:n.format,schemaVersion:n[\"format-version\"],createdAtMs:Date.now(),startNode:n.startnode},t=(validate(e),Array.from(t.getElementsByTagName(PASSAGE_TAG_NAME)));return n.passages=t.map(t=>processPassageElement(t,e)),n}function validate(e){if(!VALID_FORMATS.some(t=>t===e))throw new Error(\"Format is not valid.\")}function processPassageElement(t,e){var n=getElementAttributes(t),n={name:n.name,tags:n.tags,id:n.pid};return n.text=t.textContent.trim(),Object.assign(n,processPassageText(n.text,e)),n.cleanText=sanitizeText(n.text,n.novelEvents,n.hooks,e),n}function processPassageText(t,e){var n={novelEvents:[]};e===FORMAT_HARLOWE_3&&(n.hooks=[]);let r=0;for(;r<t.length;){var a=extractCustomTagsAtIndex(t,r),i=(a&&((i=extractCustomTagAssociatedTag(r+=a.original.length,t))&&(a.text=i),n.novelEvents.push(a)),extractLinksAtIndex(t,r));i&&(n.novelEvents.push(i),r+=i.original.length),e!==FORMAT_HARLOWE_3?r+=1:((a=extractLeftHooksAtIndex(t,r))&&(n.hooks.push(a),r+=a.original.length),(a=extractHooksAtIndex(t,r+=1))&&(n.hooks.push(a),r+=a.original.length))}return n}function extractCustomTagsAtIndex(t,e){if(\">\"===t[e]&&\">\"===t[e+1]){var n=getSubstringBetweenBrackets(t,e+1,\">\",\"<\"),t=t.substring(e,e+n.length+4),e=n.split(\"|\");if(3<e.length)throw new Error(\"Custom tag has too many parts\");return 3===e.length?{type:\"character_action_description\",index:e[0].trim(),action:e[1].trim(),expression:e[2].trim(),original:t}:2===e.length?{type:e[0].trim().toLowerCase(),name:e[1].trim(),original:t}:1===e.length?{type:e[0].trim().toLowerCase(),original:t}:void 0}}function extractCustomTagAssociatedTag(t,e){let n=t;for(;n<e.length;){var r=extractCustomTagsAtIndex(e,n),a=extractLinksAtIndex(e,n),i=extractLeftHooksAtIndex(e,n),s=extractHooksAtIndex(e,n);if(r||a||i||s)return e.substring(t,n).trim();n+=1}}function extractLinksAtIndex(t,e){var n,r,a,i,s={type:\"link\"};if(\"[\"===t[e]&&\"[\"===t[e+1])return r=(n=getSubstringBetweenBrackets(t,e+1)).split(\"<-\",2),a=n.split(\"->\",2),i=n.split(\"|\",2),t=t.substring(e,e+n.length+4),2===r.length?(s.linkText=r[1].trim(),s.passageName=r[0].trim()):2===a.length?(s.linkText=a[0].trim(),s.passageName=a[1].trim()):2===i.length?(s.linkText=i[0].trim(),s.passageName=i[1].trim()):(s.linkText=null,s.passageName=n.trim()),s.original=t,s}function extractLeftHooksAtIndex(t,e){if(\"|\"===t[e]){var n=getSubstringBetweenBrackets(t,e,\"|\",\">\");if(n.match(/[a-z0-9]+/i)){var r,a=e+n.length+2;if(\"[\"===t[a])return r=a+(a=getSubstringBetweenBrackets(t,a)).length+2,{hookName:n,hookText:a,original:t.substring(e,r)}}}}function extractHooksAtIndex(t,e){var n=t[e],r=e&&t[e-1];if(\"[\"===n&&\"[\"!==t[e+1]&&\"[\"!==r){n=getSubstringBetweenBrackets(t,e),r=e+n.length+2;if(\"<\"===t[r]){var a=getSubstringBetweenBrackets(t,r,\"<\",\"|\");if(a.match(/[a-z0-9]+/i))return{hookName:a,hookText:n,original:t.substring(e,r+a.length+2)}}return{hookName:void 0,hookText:n,original:t.substring(e,n.length+2)}}}function sanitizeText(e,t,n,r){return t.forEach(t=>{e=e.replace(t.original,\"\")}),r===FORMAT_HARLOWE_3&&n.forEach(t=>{e=e.replace(t.original,\"\")}),e.trim()}function getElementAttributes(t){let e={};return Array.from(t.attributes).forEach(t=>{e[t.name]=t.value}),e}function stringStartsWith(t,e){return t.trim().substring(0,e.length)===e}function getSubstringBetweenBrackets(t,e,n,r){n=n||\"[\",r=r||\"]\";var a=[];let i=e||0,s=\"\";if(t[i]!==n)throw new Error(\"startIndex of getSubstringBetweenBrackets must correspond to an open bracket, input: \",t);for(;i<t.length;){var o=t[i];if(o===r&&a.pop(),a.length&&(s+=o),o===n&&a.push(o),!a.length)return s;i+=1}return s}global.twineToJSON=twineToJSON;\n    </script>\n  </head>\n  <body>\n    <pre id=\"output\"></pre>\n    <div id=\"storyData\" style=\"display: none;\">\n      {{STORY_DATA}}\n    </div>\n    <script type='text/javascript'>document.getElementById('output').innerHTML = JSON.stringify(twineToJSON(\"harlowe-3\"), null, 2);</script>\n  </body>\n</html>"
});